@()
@currentUser = @{
    UserController.getCurrentUser
}
@main("Account", "Manage Account") {
    @if(!currentUser.getRole.equals("Student")) {
        <div class="mb-3 col-md-12">
            <h1>Availability Schedule</h1>
            <div class="row">
                <div class="mb-3 col-md-12">
                    <div id='availabilitySchedule'></div>
                </div>
            </div>
            <br/>
            <div class="dashCards row">
                <div class="mb-3 col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h4>Account Settings</h4>
                        </div>
                        <div class="card-block row">
                            <div class="mb-3 col-md-4">
                                <h4>Assigned Services</h4>
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <div class="container-fluid">
                                            <div class="row">
                                                <select id="selectedService" title="Services" class="mb-1 col-lg-7 form-control">
                                                    @for(service <- AccountController.getAvailableServices(currentUser.getUid)) {
                                                        <option value="@service.getServiceId">
                                                        @service.getService
                                                        </option>
                                                    }
                                                </select>
                                                <div class="col-lg-5 mb-1">
                                                    <button class="btn btn-primary btn-success" id="addService" onclick=createService()>
                                                        Add Service</button>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    @for(service <- AccountController.getServicesForUser(currentUser.getUid)) {
                                        <li class="list-group-item d-flex justify-content-between align-items-center @service.getServiceId">
                                            <h6 class="mb-1">@service.getService</h6>
                                            <button class="btn btn-primary btn-danger" onclick="removeService('@service.getServiceId')">Remove</button>
                                        </li>
                                    }
                                </ul>
                            </div>
                            @if(currentUser.getRole.equals("Admin")) {
                                <div class="mb-3 col-md-4">
                                    <h4>Account Settings</h4>
                                    <div class="input-group container">
                                        <input onclick="isCoachCheck()" type="checkbox" class="form-check-input" @if(currentUser.isCoach) {checked} id="isCoachCheck">
                                        <label class="form-check-label" for="isCoachCheck">Act as coach</label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
                function isCoachCheck() {
                    let checked = $("#isCoachCheck").is(':checked');
                    let userId = '@currentUser.getUid';
                    data = {checked: checked, userId: userId};
                    $.ajax({
                        url: '/isCoachChecked',
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function () {
                            createAlert("success", "Coach status updated!");
                        },
                        error: function () {
                            createAlert('danger', 'Coach status change failed.');
                        }
                    });
                }

                function removeService(serviceId) {
                    $.confirm({
                        title: 'Remove Service',
                        content: 'Are you sure you want to remove this service?',
                        escapeKey: 'cancel',
                        buttons: {
                            confirm: {
                                text: 'Yes, Remove',
                                btnClass: "btn btn-primary",
                                keys: ['enter'],
                                action: function () {
                                    const form = {
                                        userId: '@currentUser.getUid',
                                        serviceId: serviceId
                                    };
                                    $.ajax({
                                        url: '/removeServiceFromCoach',
                                        type: 'POST',
                                        data: JSON.stringify(form),
                                        contentType: 'application/json',
                                        success: function () {
                                            createAlert("success", "Service Removed!");
                                            location.reload();
                                        },
                                        error: function () {
                                            createAlert('danger', 'Removing service failed.');
                                        }
                                    });
                                }
                            },
                            cancel: {
                                text: 'Cancel'
                            }
                        }
                    });
                }

                function createService() {
                    let selectedService = $('#selectedService :selected');
                    let selectedServiceText = selectedService.text();
                    let selectedServiceId = selectedService.val();
                    if (selectedServiceId === "" || selectedServiceId === null) {
                        $.alert({
                            title: "Select Service",
                            content: "Please select a service to add."
                        })
                    } else {
                        $.confirm({
                            title: 'Add Service',
                            content: 'Do you want add ' + selectedServiceText + ' as a service you provide?',
                            escapeKey: 'cancel',
                            buttons: {
                                confirm: {
                                    text: 'Confirm',
                                    btnClass: "btn btn-primary",
                                    keys: ['enter'],
                                    action: function () {
                                        const form = {
                                            userId: '@currentUser.getUid',
                                            serviceName: selectedServiceText,
                                            serviceId: selectedServiceId
                                        };
                                        $.ajax({
                                            url: '/addServiceToCoach',
                                            type: 'POST',
                                            data: JSON.stringify(form),
                                            contentType: 'application/json',
                                            success: function () {
                                                createAlert("success", "Service Added!");
                                                location.reload();
                                            },
                                            error: function () {
                                                createAlert('danger', 'Adding service failed.');
                                            }
                                        });
                                    }
                                },
                                cancel: {
                                    text: 'Cancel'
                                }
                            }
                        });
                    }
                }

                $(document).ready(function () {
                    const dropDown = $("#selectedService");
                    if (dropDown.has('option').length === 0) {
                        dropDown.prepend("<option id='default' value='' selected disabled hidden>No More Services</option>");
                        $("#addService").hide();
                    } else {
                        dropDown.prepend("<option id='default' value='' selected disabled hidden>Select A Service</option>");
                    }
                    $('#availabilitySchedule').fullCalendar({
                        height: 'auto',
                        themeSystem: 'bootstrap4',
                        allDaySlot: false,
                        validRange: {
                            start: moment('@SettingsController.getSettings.getSemesterStart.toInstant').format("YYYY-MM-DD"),
                            end: moment('@SettingsController.getSettings.getSemesterEnd.toInstant').format("YYYY-MM-DD")
                        },
                        minTime: moment('@SettingsController.getSettings.getStartTime.toInstant').format("HH:mm"),
                        maxTime: moment('@SettingsController.getSettings.getEndTime.toInstant').format("HH:mm"),
                        events: function (start, end, timezone, callback) {
                            $.ajax({
                                url: '/availableSlots/' + '@currentUser.getUid' + '/' + moment(start).toISOString() + '/' + moment(end).toISOString(),
                                type: 'GET',
                                success: function (response) {
                                    let events = [];
                                    $(response).each(function () {
                                        const event = {
                                            id: $(this).attr('availabilityId'),
                                            title: "One-Time",
                                            start: moment($(this).attr('startDate')),
                                            end: moment($(this).attr('endDate')),
                                            dow: []
                                        };
                                        if ($(this).attr("weekly") === true) {
                                            event.title = "Weekly";
                                            event.dow = [moment($(this).attr('startDate')).isoWeekday()];
                                            event.start = moment($(this).attr('startDate')).format("HH:mm");
                                            event.end = moment($(this).attr('endDate')).format("HH:mm");
                                        }
                                        events.push(event);
                                    });
                                    callback(events);
                                }
                            })
                        },
                        eventOverlap: false,
                        selectOverlap: false,
                        disableDragging: true,
                        eventRender: function (event, eventElement) {
                            eventElement.find("div.fc-content").prepend("<button onclick='removeAvailability(\"" + event.id + "\")' class='no-button eventDelete'><i class=\"material-icons md-18\">close</i></button>");
                        },
                        weekends: false,
                        selectable: true,
                        defaultView: 'agendaWeek',
                        navLinks: false,
                        eventLimit: false,
                        select: function (start, end, jsEvent, view) {
                            const newAvailability = {
                                userId: '@currentUser.getUid',
                                startDate: moment(start).format(),
                                endDate: moment(end).format(),
                                weekly: false
                            };
                            $.confirm({
                                title: 'Availability',
                                content: 'Is this slot available weekly?',
                                columnClass: "col-md-11",
                                theme: 'modern',
                                escapeKey: 'cancel',
                                buttons: {
                                    yes: {
                                        text: 'Yes, weekly',
                                        btnClass: 'btn-primary',
                                        action: function () {
                                            newAvailability.weekly = true;
                                            createAvailability(newAvailability);
                                        }
                                    },
                                    no: {
                                        text: 'No, one-time',
                                        btnClass: 'btn-primary',
                                        action: function () {
                                            createAvailability(newAvailability);
                                        }
                                    },
                                    cancel: {
                                        text: 'Cancel Creating Availability',
                                        action: function () {
                                        }
                                    }
                                }
                            });
                        }
                    })
                });

                function removeAvailability(id) {
                    $.confirm({
                        title: 'Remove Availability?',
                        content: 'Do you want to remove this availability slot?',
                        theme: 'modern',
                        escapeKey: 'cancel',
                        buttons: {
                            yes: {
                                text: 'Remove',
                                btnClass: 'btn-primary',
                                keys: ['enter'],
                                action: function () {
                                    $.ajax({
                                        url: '/removeAvailability',
                                        type: 'POST',
                                        data: JSON.stringify({availabilityId: id}),
                                        contentType: 'application/json',
                                        success: function () {
                                            setTimeout(function () {
                                                $('#availabilitySchedule').fullCalendar('rerenderEvents');
                                                $('#availabilitySchedule').fullCalendar('refetchEvents');
                                                createAlert("success", "Availability Removed!");
                                            }, 50);
                                        },
                                        error: function (err) {
                                            console.log(err);
                                        }
                                    });
                                }
                            },
                            cancel: {
                                text: 'Cancel',
                                action: function () {
                                }
                            }
                        }
                    });
                }

                function createAvailability(newAvailability) {
                    $.ajax({
                        url: '/createAvailability',
                        type: 'POST',
                        data: JSON.stringify(newAvailability),
                        contentType: 'application/json',
                        success: function () {
                            setTimeout(function () {
                                $('#availabilitySchedule').fullCalendar('rerenderEvents');
                                $('#availabilitySchedule').fullCalendar('refetchEvents');
                            }, 250);
                        },
                        error: function (err) {
                            console.log(err);
                        }
                    });
                }
        </script>

    }
}




