@()

@main("Account", "Manage Account") {
    @if(!UserController.getCurrentUser.getRole.equals("Student")){
    @helper.CSRF.formField
    <h1>Availability Schedule</h1>
    <div class="col-md-12">
        <div id='availabilitySchedule'></div>
    </div>
    <script>
            $(document).ready(function () {
                $('#availabilitySchedule').fullCalendar({
                    height: 'auto',
                    allDaySlot: false,
                    events: function (start, end, timezone, callback) {
                        var csrfToken = $('input[name="csrfToken"]').attr('value');
                        $.ajaxSetup({
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Csrf-Token', csrfToken);
                            }
                        });
                        $.ajax({
                            url: '/availableSlots/' + '@UserController.getCurrentUser.getUid',
                            type: 'GET',
                            success: function (response) {
                                var events = [];
                                $(response).each(function () {
                                    var event = {
                                        id: $(this).attr('availabilityId'),
                                        title: "One-Time",
                                        start: $(this).attr('startDate'),
                                        end: $(this).attr('endDate'),
                                        dow: []
                                    };
                                    if ($(this).attr("weekly") === true) {
                                        event.title = "Weekly";
                                        event.dow = [moment($(this).attr('startDate')).isoWeekday()];
                                        event.start = moment($(this).attr('startDate')).format("HH:mm");
                                        event.end = moment($(this).attr('endDate')).format("HH:mm");
                                    }
                                    events.push(event);
                                });
                                callback(events);
                            }
                        })
                    },
                    eventOverlap: false,
                    selectOverlap: false,
                    eventRender: function (event, eventElement) {
                        eventElement.find("div.fc-content").prepend("<button onclick='removeAvailability(\"" + event.id + "\")' class='no-button eventDelete'><i class=\"material-icons md-18\">close</i></button>");
                    },
                    /* TODO pull from open / close hours of operation in settings page */
                    minTime: "10:00",
                    maxTime: "21:00",
                    weekends: false,
                    editable: true,
                    selectable: true,
                    defaultDate: moment().startOf('isoWeek'),
                    defaultView: 'agendaWeek',
                    navLinks: true, // can click day/week names to navigate views
                    eventLimit: true, // allow "more" link when too many events,
                    eventDrop: function (event, delta, revertFunc) {
                        console.log(event);
                        var changedEvent = {
                            availabilityId: event.id,
                            userId: '@UserController.getCurrentUser.getUid',
                            startDate: moment(event.start).format(),
                            endDate: moment(event.end).format(),
                            weekly: event.dow.length > 0
                        };
                        createAvailability(changedEvent);
                    },
                    eventResize: function (event, delta, revertFunc) {
                        var changedEvent = {
                            availabilityId: event.id,
                            userId: '@UserController.getCurrentUser.getUid',
                            startDate: moment(event.start).format(),
                            endDate: moment(event.end).format(),
                            weekly: event.dow.length > 0
                        };
                        createAvailability(changedEvent);
                    },
                    select: function (start, end, jsEvent, view) {
                        var newAvailability = {
                            userId: '@UserController.getCurrentUser.getUid',
                            startDate: moment(start).format(),
                            endDate: moment(end).format(),
                            weekly: false
                        };
                        $.confirm({
                            title: 'Availability',
                            content: 'Is this available slot weekly?',
                            theme: 'modern',
                            buttons: {
                                yes: {
                                    text: 'Yes, weekly',
                                    btnClass: 'btn-primary',
                                    keys: ['enter', 'shift'],
                                    action: function () {
                                        newAvailability.weekly = true;
                                        createAvailability(newAvailability);
                                    }
                                },
                                no: {
                                    text: 'No, one-time',
                                    btnClass: 'btn-primary',
                                    action: function () {
                                        createAvailability(newAvailability);
                                    }
                                },
                                cancel: {
                                    text: 'Cancel Creating Availability',
                                    action: function () {
                                    }
                                }
                            }
                        });
                    }
                })
            });

            function removeAvailability(id) {
                $.confirm({
                    title: 'Alert',
                    content: 'Do you want to remove this availability slot?',
                    theme: 'modern',
                    buttons: {
                        yes: {
                            text: 'Remove',
                            btnClass: 'btn-primary',
                            keys: ['enter', 'shift'],
                            action: function () {
                                var csrfToken = $('input[name="csrfToken"]').attr('value');
                                $.ajaxSetup({
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader('Csrf-Token', csrfToken);
                                    }
                                });
                                $.ajax({
                                    url: '/removeAvailability',
                                    type: 'POST',
                                    data: JSON.stringify({availabilityId: id}),
                                    contentType: 'application/json',
                                    success: function () {
                                        setTimeout(function () {
                                            $('#availabilitySchedule').fullCalendar('rerenderEvents');
                                            $('#availabilitySchedule').fullCalendar('refetchEvents');
                                            createAlert("success", "Availability Removed!");
                                        }, 50);
                                    },
                                    error: function (err) {
                                        console.log(err);
                                    }
                                });
                            }
                        },
                        cancel: {
                            text: 'Cancel',
                            action: function () {
                            }
                        }
                    }
                });
            }

            function createAvailability(newAvailability) {
                var csrfToken = $('input[name="csrfToken"]').attr('value');
                $.ajaxSetup({
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Csrf-Token', csrfToken);
                    }
                });
                $.ajax({
                    url: '/createAvailability',
                    type: 'POST',
                    data: JSON.stringify(newAvailability),
                    contentType: 'application/json',
                    success: function () {
                        setTimeout(function () {
                            $('#availabilitySchedule').fullCalendar('rerenderEvents');
                            $('#availabilitySchedule').fullCalendar('refetchEvents');
                        }, 50);
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }
    </script>

    }
}




