@import controllers.ApplicationComponents.AppointmentType
@import controllers.Databases.UserDB
@import controllers.ApplicationComponents.Role
@()

@main("Dashboard", "Dashboard") {
    @helper.CSRF.formField
    <a href="/MakeAppointment">Make a New Appointment</a>
    @* Will be moved into a modal for other page sections *@
    <ul class="stepper linear">
        <li class="step active">
            <div class="step-title waves-effect">Appointment Type</div>
            <div class="step-content col-md-2">
                <div>
                    <label for="appointmentType"></label>
                    <select id="appointmentType" name="appointmentType" required>
                        <option selected disabled> Select an Appointment Type </option>
                        @for(aType <- AppointmentType.values()) {
                            @if(!aType.equals(AppointmentType.DEFAULT)) {
                                <option value="@aType.appointmentType()">@aType.appointmentType()</option>
                            }
                        }
                    </select> &nbsp; @partials.components._popoverIconLink("help","right","Appointment Type",
                                                                            "<b>Regular</b>: One-on-one with a coach in the center." +
                                                                            "<br/><br/> <b>Weekly</b>: A recurring weekly regular appointment." +
                                                                            "<br/><br/> <b>Online</b>: Submit a paper for a coach to read and receive comments back.", 24)
                </div>
                <div class="step-actions">
                    <button class="btn btn-primary next-step">Next Step</button>
                </div>
            </div>
        </li>
        <li class="step">
            <div class="step-title waves-effect">Select Coach</div>
            <div class="step-content  col-md-2">
                <div>
                    <label for="coachId"></label>
                    <select id="coachId" name="appointmentType" required>
                        <option selected disabled> Select a coach </option>
                        <option value="Any">Any Coach</option>
                        @for(coach <- UserDB.getUsers) {
                            @if(coach.getRole.equals(Role.COACH.role())) {
                                <option value="@coach.getUid">@coach.getDisplayName</option>
                            }
                        }
                    </select>
                </div>
                <div class="step-actions">
                    <button class="btn btn-secondary previous-step">Previous Step</button>
                    <button class="btn btn-primary next-step">Next Step</button>
                </div>
            </div>
        </li>
        <li class="step">
            <div class="step-title waves-effect">Appointment Notes</div>
            <div class="step-content col-md-2">
                <div>
                    <div class="form-group">
                    <label for="appointmentNotes">What will the appointment be about?</label>
                    <textarea class="form-control" rows="5" id="appointmentNotes"></textarea>
                    </div>
                </div>
                <div class="step-actions">
                    <button class="btn btn-secondary previous-step">Previous Step</button>
                    <button class="btn btn-primary next-step">Next Step</button>
                </div>
            </div>
        </li>
        <li class="step">
            <div class="step-title waves-effect">Appointment Time</div>
            <div class="step-content col-md-2">
                <div>
                @partials.components._appointmentCalendarForNewAppointment()
                </div>
                <div class="step-actions">
                    <button class="btn btn-primary" onclick="createAppointment()" type="submit">Create Appointment</button>
                </div>
            </div>
        </li>
    </ul>
    <script>
            $(function () {
                $('.stepper').activateStepper();
            });

            function createAppointment() {
                if (selectedEvents.length <= 0) {
                    alert('No appointments have been selected');
                }
                var appointment = {
                    id: selectedEvents[0].id,
                    startDate: selectedEvents[0].start,
                    endDate: selectedEvents[0].end
                };
                var form = {
                    appointmentType: $('#appointmentType').val(),
                    coachId: $('#coachId').val(),
                    studentId: firebase.auth().currentUser.uid,
                    appointmentId: appointment.id,
                    startDate: appointment.startDate,
                    endDate:   appointment.endDate,
                    appointmentNotes: $('#appointmentNotes').val(),
                    present: false
                };
                if(confirm("Your appointment details:\n\n" +
                        "Appointment Type: " + form.appointmentType + "\n" +
                        "Coach: " + $("#coachId option:selected").text() + "\n" +
                        "Date: " + moment(appointment.start).format('dddd, MMMM Do, YYYY h:mm:ss A') + "\n\n" +
                        "Confirm Appointment?")) {
                    /* Create appointment Here*/
                    var csrfToken = $('input[name="csrfToken"]').attr('value');
                    $.ajaxSetup({
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Csrf-Token', csrfToken);
                        }
                    });
                    console.log(JSON.stringify(form));
                    $.ajax({
                        url: '/createAppointment',
                        type: 'POST',
                        data: JSON.stringify(form),
                        contentType: 'application/json',
                        success: function() {
                            createAlert("success", "Appointment Created!");
                        },
                        error: function () {
                            createAlert('danger', 'Appointment creation failed.');
                        }
                    });
                } else {
                    createAlert("info", "Appointment Not Created");
                }
            }
    </script>
}

