@import controllers.Databases.UserDB
@()
    @currentUser = @{
        UserController.getCurrentUser
    }
    @main("Dashboard", "Your Dashboard") {
            <script type="text/javascript">
                $(document).ready(function(){
                    if (Cookies.get('newUser') === "true") {
                        Cookies.remove('newUser');
                        $(document).ready(function () {
                            $.alert({
                                title: "Welcome to Project Burgundy!",
                                content: "Project Burgundy is a <b>beta</b> web app to handle appointment scheduling at learning centers <br/><br/>" +
                                "We're MTU students who are constantly working to improve this application and provide a great scheduling experience for students. <br/><br/>" +
                                "If you find <b>any</b> bugs or have any feature requests, please click on \"Feedback\" in the footer and send us a note! <br/><br/>" +
                                "<b>Thank you</b> <br/>" +
                                " - The Project Burgundy Team"
                            });
                        });
                    }
                });
            </script>
        <div class="mb-3 col-md-12 dashCards">
            <div class="row">
                <div class="mb-3 col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h4>Hello, @{
                                UserController.getCurrentUser.getDisplayName
                            } </h4>
                        </div>
                        <div class="card-block">
                            <div class="row col-md-12">
                                <img src="@currentUser.getPhotoURL" class="mdl-list__item-avatar mb-2"/>
                                <span class="appointmentCount"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 col-md-4">
                    <div class="card text-center">
                        <div class="card-header">
                            <h4>Quick-Schedule</h4>
                        </div>
                        <div class="card-block">
                            <button onclick="createNewAppointment()" class="btn btn-primary mb-3 col-12">
                                Schedule New Appointment
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-3 col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h4>Stay up to date</h4>
                        </div>
                        <div class="card-block">
                            <h6>Notifications:</h6>
                            <ul class="list-group" id="notifications">
                            @if(UserDB.getNotificaitonsForUser(currentUser.getUid).size() == 0) {
                                There are currently no notifications to display.
                            } else {
                                @for(notification <- UserDB.getNotificaitonsForUser(currentUser.getUid)) {
                                    <li class="list-group-item @notification.getNotificationId">@notification.getNotificationContent <button onclick="deleteNotification('@notification.getNotificationId')" class="no-button deleteNotification"><i class="material-icons md-18">backspace</i></button></li>
                                }
                                <button class="clearAll no-button" id="notificationButton">Clear All</button>
                            }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <div class="row">
                <div class="mb-3 col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4>Appointment Calendar</h4>
                        </div>
                        <div>
                            <div id="appointmentCalendar"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-3 col-md-6">
                    <div class="card nextFiveAppointments">
                        <div class="card-header">
                            <h4 class="float-left">Next Five Appointments</h4>
                            <a href="/Appointments" class="btn btn-outline-light float-right align-middle">
                                View Appointment List</a>
                        </div>
                        @partials.components._nextFiveAppointments()
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">

                function deleteNotification(notificationId) {
                    $.ajax({
                        url: '/removeNotificationFromUser',
                        data: JSON.stringify({
                            userId: '@currentUser.getUid',
                            notificationId: notificationId
                        }),
                        contentType: 'application/json',
                        type: 'POST',
                        success: function (response) {
                            /* TODO load from AJAX so we don't have to reload or hide element from */
                            createAlert("success", "Notification Removed.");
                            $('.' + notificationId).hide();
                        }
                    })
                }

                $(document).ready(function () {

                    $('.clearAll').on('click', function () {
                        $('.deleteNotification').click();
                        $(this).html("There are currently no notifications to display.");
                    });

                    $('#appointmentCalendar').fullCalendar({
                        header: false,
                        defaultView: 'agendaWeek',
                        height: 'auto',
                        editable: false,
                        weekends: false,
                        minTime: moment('@SettingsController.getSettings.getStartTime.toInstant').format("HH:mm"),
                        maxTime: moment('@SettingsController.getSettings.getEndTime.toInstant').format("HH:mm"),
                        allDaySlot: false,
                        selectable: false,
                        events: function (start, end, timezone, callback) {
                            $.ajax({
                                url: '/appointmentsForUser/' + '@currentUser.getRole' + '/' + '@currentUser.getUid' + '/' + moment(start).toISOString() + '/' + moment(end).toISOString(),
                                type: 'GET',
                                success: function (response) {
                                    let upcomingCount = 0;
                                    const events = [];
                                    $(response).each(function () {
                                        const userID = '@currentUser.getUid';
                                        const role = '@currentUser.getRole';
                                        let title = "";
                                        if (userID === $(this).attr("studentId")) {
                                            if (role !== "Student") {
                                                title = $(this).attr("studentName")
                                            } else {
                                                title = $(this).attr("coachName")
                                            }
                                        } else {
                                            title = $(this).attr("studentName")
                                        }
                                        const event = {
                                            id: $(this).attr('availabilityId'),
                                            title: title,
                                            start: moment($(this).attr('startDate')),
                                            end: moment($(this).attr('endDate')),
                                            dow: [],
                                        };
                                        if(!event.start.local().isBefore(moment())){
                                            upcomingCount++;
                                        }
                                        events.push(event);
                                    });
                                    $(".appointmentCount").html("You have " + upcomingCount + (upcomingCount === 1 ? " appointment this week." : " appointments this week."));
                                    callback(events);
                                }
                            })
                        },
                    });
                });


        </script>
        @partials.components._createNewAppointmentFlow_Scripts()
    }