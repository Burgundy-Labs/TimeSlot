@import controllers.Databases.UserDB
@(userId: String, readAll: Boolean)
@currentUser = @{
    UserDB.getUser(userId)
}
@currentSettings = @{
    SettingsController.getSettings
}
<div class="card">
    <div class="card-header">
        <h4 class="float-left">Appointment List</h4>
    </div>
    <div class="card-body">
        <div class="weekSelect row col-12 ">
            <button onClick="prevWeek()" class="btn btn-primary col-md-2"><i class="material-icons md-18">navigate_before</i> Previous Week</button>
            <div class="weekText col-md-8"><h3><small><span class="weekSelected"></span></small></h3></div>
            <button onClick="nextWeek()" class="btn btn-primary col-md-2">Next Week <i class="material-icons md-18">navigate_next</i></button>
        </div>
        <br/>
        <div class="table-responsive cardTable">
            <table class="table table-striped appointmentList col-md-12" cellspacing="0" width="100%" id="appointmentList" style="width: 100%">
                <thead>
                    <tr>
                        <th></th>
                        <th>Student</th>
                        <th>Coach</th>
                        <th>Type</th>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Attendance</th>
                        <th>Student's Notes</th>
                        <th id="manage">Manage</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script type="text/javascript">
@if((currentUser.isCoach != null && currentUser.isCoach) || currentUser.getRole.equals("Coach")) {

$(document).on('click', '.attendanceSelect', function () {
    $(this).data('prev', $(this).val());
});

$(document).on('change', '.attendanceSelect', function () {
    let e = $(this);
    let newPresence = $(this).val();
    let appointment = {
        appointmentId: $(this).data('id'),
        present: newPresence
    };
    $.ajax({
        url: '/updatePresence',
        type: 'POST',
        data: JSON.stringify(appointment),
        contentType: 'application/json',
        success: function () {
            if (newPresence === 'true') {
                e.removeClass('danger-border');
                e.addClass('success-border');
            } else {
                e.removeClass('success-border');
                e.addClass('danger-border');
            }
            createAlert('info', 'Attendance Changed');
        },
        error: function (err) {
            createAlert('warning', 'Error changing attendance!');
            console.log(err);
        }
    });
});
}
let selectedDate;
$(document).ready(function () {
    if (moment().weekday() >= 5 || moment().weekday() === 0) {
        selectedDate = moment().add(3, 'days').isoWeekday(1);
    } else {
        selectedDate = moment().isoWeekday(1);
    }
    updateDate();

    $('.appointmentNotes').shorten({
        showChars: 150
    });
});

function updateDate() {
    let endDate = moment(selectedDate);
    $(".weekSelected").html(selectedDate.format("dddd MMMM Do ") + " - " + endDate.isoWeekday(5).format("dddd MMMM Do "));
    let t = $('#appointmentList');
    t.DataTable().clear();
    t.DataTable({
        retrieve: true,
        dom: 'frtlip',
        order: [[5, 'asc']],
        responsive: true,
    });
    t.DataTable().draw();
    $.ajax({
        async: false,
        @if(currentUser.getRole.equals("Admin") && readAll){
        url: '/appointmentsByDate/@currentUser.getRole/@currentUser.getUid/' + moment(selectedDate).format("YYYY-MM-DD") + '/' + moment(endDate).format("YYYY-MM-DD"),
        } else {
        url: '/appointmentsForUser/@currentUser.getRole/@currentUser.getUid/' + moment(selectedDate).format("YYYY-MM-DD") + '/' + moment(endDate).format("YYYY-MM-DD"),
        }
        type: 'GET',
        success: function (response) {
            $(response).each(function () {
                t.DataTable().rows.add([{
                    0: `<img src="${$(this).attr('studentPhoto')}" class="userAvatar"/>`,
                    1: `<a href='/User/${$(this).attr('studentId')}'>${$(this).attr('studentName')}</a>`,
                    2: `<a href='/User/${$(this).attr('coachId')}'>${$(this).attr('coachName')}</a>`,
                    3: $(this).attr('appointmentType'),
                    4: $(this).attr('serviceType'),
                    5: moment(zonedDate($(this).attr('startDate'))).format("MM/DD/YYYY hh:mm") + " - " + moment(zonedDate($(this).attr('endDate'))).format("hh:mm A"),
                    6: @if(!currentUser.getRole.equals("Student")) {
                            `<select data-id="${$(this).attr("appointmentId")}" class="selectpicker  ${($(this).attr("present") ? "success" : "danger")}-border" title="Appointment Attendance">
            <option value="${$(this).attr("present")}" selected>
                ${($(this).attr("present") ? "&#10004;" : "&#x2716;")}
                </option>
            <option value="${!$(this).attr("present")}">
                ${!$(this).attr("present") ? "&#10004;" : "&#x2716;"}
            </option>
        </select>` } else {` ${$(this).attr("present") ? "&#10004;" : "&#x2716;"}`
                    },
                    7: `<span class="appointmentNotes">${$(this).attr('appointmentNotes')}</span>`,
                    8: @if(currentUser.getRole.equals("Student")) {
                    `<button class="no-button"><span class="action-primary"><a href="mailto:${$(this).attr("coachEmail")}" data-toggle="tooltip" data-placement="bottom" title="Email Coach" class="md-32"><i class="material-icons md-32">email</i></a></span></button>`
                            } else {
                            `<button class="no-button"><span class="action-primary"><a href="mailto:${$(this).attr("studentEmail")}" data-toggle="tooltip" data-placement="bottom" title="Email Student" class="md-32"><i class="material-icons md-32">email</i></a></span></button>`
                    }
                    @if(currentUser.getRole.equals("Coach") || (currentUser.isCoach != null && currentUser.isCoach)) {
                    + `
                            ${$(this).attr("coachNotes") === "" ?
                            `<button id="notesFor-${$(this).attr("appointmentId")}" class="no-button" onclick="updateCoachNotes('${$(this).attr("appointmentId")}', '${$(this).attr("coachNotes")}')"><span class="action-black" id="appointmentNotes"><a href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="Session Notes" class="md-32"><i class="material-icons md-32">assignment</i></a> </span></button>`
                            :
                            `<button id="notesFor-${$(this).attr("appointmentId")}" class="no-button" onclick="updateCoachNotes('${$(this).attr("appointmentId")}', '${$(this).attr("coachNotes")}')"><span class="action-secondary" id="appointmentNotes"><a href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="Session Notes" class="md-32"><i class="material-icons md-32">assignment</i></a> </span></button>`
                            }
                            `} + `${!moment($(this).attr('startDate')).local().isBefore(moment()) ? `<button class="no-button" onclick="cancelAppointment('${$(this).attr("appointmentId")}','${$(this).attr("weekly")}','${$(this).attr("weeklyId")}')"><span class="action-delete"><a href="javascript:void(0)" data-toggle="tooltip" data-placement="bottom" title="Cancel Appointment" class="md-32"><i class="material-icons md-32">close</i></a></span></button>` : ``}
                                `,
                    9: `<a class="btn btn-primary" href="https://www.google.com/calendar/render?action=TEMPLATE&text=@currentSettings.getCenterName.replaceAll(" ", "+")+Appointment+With+${$(this).attr("studentName").replace(" ", "+")}&dates=${(!moment().isDST() && moment($(this).attr("startDate")).isDST()) ? moment($(this).attr('startDate')).subtract(1, 'hour').utc().format("YYYYMMDDTHHmmss[Z]") + "/" + moment($(this).attr('endDate')).subtract(1, 'hour').utc().format("YYYYMMDDTHHmmss[Z]") : (moment().isDST() && !moment($(this).attr("startDate")).isDST()) ? moment($(this).attr('startDate')).add(1, 'hour').utc().format("YYYYMMDDTHHmmss[Z]") + "/" + moment($(this).attr('endDate')).add(1, 'hour').utc().format("YYYYMMDDTHHmmss[Z]") : moment($(this).attr('startDate')).utc().format("YYYYMMDDTHHmmss[Z]") + "/" + moment($(this).attr('endDate')).utc().format("YYYYMMDDTHHmmss[Z]")}&details=${$(this).attr("description").replace("<br/>", "%0A").replace(" ", "+")}&location=@currentSettings.getCenterName.replaceAll(" ", "+")&sf=true&output=xml"
                                target="_blank" rel="nofollow">Add to calendar</a>`,
                }]).draw();
            });
        }
    });
}

function prevWeek() {
    selectedDate = moment(selectedDate).subtract(1, 'weeks').isoWeekday(1);
    updateDate();
}

function nextWeek() {
    selectedDate = moment(selectedDate).add(1, 'weeks').isoWeekday(1);
    updateDate();
}

function updateCoachNotes(appointmentId, coachNotes) {
    $.confirm({
        closeIcon: true,
        columnClass: "col-12",
        title: 'Session Notes',
        content: '' +
        '<form action="" class="coachNoteForm">' +
        '<div class="form-group">' +
        '<label>Enter notes about the appointment here. </label>' +
        '<textarea cols="50" rows="10" class="coachNotes form-control" required>' + coachNotes + '</textarea>' +
        '</div>' +
        '</form>',
        escapeKey: true,
        buttons: {
            cancel: {
                text: "Cancel",
                btnClass: "btn",
                keys: ["esc"]
            },
            updateNotes: {
                text: 'Update Coach Notes',
                btnClass: 'btn-primary',
                keys: ['enter'],
                action: function () {
                    coachNotes = this.$content.find('.coachNotes').val();
                    $.ajax({
                        url: '/updateCoachNotes',
                        type: 'POST',
                        data: JSON.stringify({appointmentId: appointmentId, coachNotes: coachNotes}),
                        contentType: 'application/json',
                        success: function () {
                            $('#notesFor-' + appointmentId).attr("onclick", 'updateCoachNotes("' + appointmentId + '", "' + coachNotes + '")');
                            $().val(coachNotes);
                            let spanIcon = $('#notesFor-' + appointmentId + ' span');
                            if (coachNotes === '' || coachNotes === null) {
                                spanIcon.removeClass('action-secondary');
                                spanIcon.addClass('action-black');
                            } else {
                                spanIcon.removeClass('action-black');
                                spanIcon.addClass('action-secondary');
                            }
                        },
                        error: function (err) {
                            createAlert("danger", "There was an error updating coach notes");
                        }
                    });
                }
            },
        },
    });
}

function cancelAppointment(appointmentId, isWeekly, weeklyId) {
    $.confirm({
        title: 'Cancel Appointment',
        content: 'Reason for Cancelling:<textarea class="form-control" rows="5" id="cancelNotes" placeholder="I can\'t come to the appointment anymore because..."></textarea>',
        escapeKey: 'cancel',
        buttons: {
            next: {
                text: 'Next',
                btnClass: 'btn-primary mb-3 col-md-12',
                action: function () {
                    let cancelNotes = this.$content.find('#cancelNotes').val();
                    $.confirm({
                        onOpenBefore: function () {
                            if (isWeekly == "false") {
                                this.buttons.deleteAll.hide();
                            }
                        },
                        title: 'Cancel Appointment',
                        content: 'Are you sure you want to cancel this appointment?',
                        escapeKey: 'cancel',
                        buttons: {
                            deleteOne: {
                                text: 'Cancel This Appointment',
                                btnClass: 'btn-primary mb-3 col-md-12',
                                action: function () {
                                    $.ajax({
                                        url: '/cancelAppointment',
                                        type: 'POST',
                                        data: JSON.stringify({
                                            appointmentId: appointmentId,
                                            weeklyId: null,
                                            cancelNotes: cancelNotes
                                        }),
                                        contentType: 'application/json',
                                        success: function () {
                                            updateDate();
                                            createAlert("success", "Appointment cancelled.");
                                        },
                                        error: function (err) {
                                            console.log(err);
                                        }
                                    });
                                }
                            },
                            deleteAll: {
                                text: 'Cancel All Appointments in Series',
                                btnClass: 'btn-primary mb-3 col-md-12',
                                action: function () {
                                    $.ajax({
                                        url: '/cancelAppointment',
                                        type: 'POST',
                                        data: JSON.stringify({
                                            appointmentId: appointmentId,
                                            weeklyId: weeklyId,
                                            cancelNotes: cancelNotes
                                        }),
                                        contentType: 'application/json',
                                        success: function () {
                                            updateDate();
                                            createAlert("success", "Appointments cancelled.");
                                        },
                                        error: function (err) {
                                            console.log(err);
                                        }
                                    });
                                }
                            },
                            cancel: {
                                text: "Nevermind",
                                btnClass: "mb-3 col-md-12"
                            }
                        },
                    });
                }
            },
            cancel: {
                text: 'Nevermind',
                btnClass: 'mb-3 col-md-12',
            }
        }
    });
    setTimeout(function () {
        $(".jconfirm-buttons").addClass("col-12");
    }, 200);
}

</script>
