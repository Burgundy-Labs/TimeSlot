@import controllers.Databases.AppointmentsDB
@import java.time.format.DateTimeFormatter
@import java.time.ZoneOffset
@currentUser = @{UserController.getCurrentUser}
<table class="table table-striped appointmentList" cellspacing="0" width="100%" id="appointmentList">
    <thead>
        <tr>
            <th></th>
            <th>Student</th>
            <th>Coach</th>
            <th>Type</th>
            <th>Service</th>
            <th>Start</th>
            <th>End</th>
            <th>Attendance</th>
            <th>Student's Notes</th>
            <th>Manage</th>
        </tr>
    </thead>
    <tbody>
    @for(appointment <- AppointmentsDB.getAppointments) {
        <tr class="@appointment.getAppointmentId">
            <td>
                <img src="@appointment.getStudentPhoto" class="userAvatar"/>
            </td>
            <td>
            @appointment.getStudentName
            </td>
            <td>
            @appointment.getCoachName
            </td>
            <td>@appointment.getAppointmentType</td>
            <td>@appointment.getServiceType</td>
            <td class="date"> @DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mmX").withZone(ZoneOffset.UTC).format(appointment.getStartDate.toInstant)</td>
            <td class="date"> @DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mmX").withZone(ZoneOffset.UTC).format(appointment.getEndDate.toInstant)</td>
            <td class="attendance">@partials.components._appointmentAttendanceDropdown(appointment, currentUser)</td>
            <td class="appointmentNotes">@appointment.getAppointmentNotes</td>
            <td>
                <span class="mdl-list__item-secondary-content">
                    @if(currentUser.getRole.equals("Student")){
                        <button class="no-button"> <span class="action-primary">@partials.components._tooltipIconLink("mailto:" + appointment.getCoachEmail, "email", "bottom", "Email Coach", 32)</span></button>
                    } else {
                        <button class="no-button"> <span class="action-primary">@partials.components._tooltipIconLink("mailto:" + appointment.getStudentEmail, "email", "bottom", "Email Student", 32)</span></button>
                    }
                    @if(appointment.getCoachNotes.equals("")){
                        <button id="notesFor-@appointment.getAppointmentId" class="no-button" onclick="updateCoachNotes('@appointment.getAppointmentId','@appointment.getCoachNotes')"><span class="action-black" id="appointmentNotes">@partials.components._tooltipIconLink("javascript:void(0)", "assignment", "bottom", "Session Notes", 32)</span></button>
                    } else {
                        <button id="notesFor-@appointment.getAppointmentId" class="no-button" onclick="updateCoachNotes('@appointment.getAppointmentId','@appointment.getCoachNotes')"><span class="action-secondary" id="appointmentNotes">@partials.components._tooltipIconLink("javascript:void(0)", "assignment", "bottom", "Session Notes", 32)</span></button>
                    }
                    <button class="no-button" onclick="cancelAppointment('@appointment.getAppointmentId')"><span class="action-delete">@partials.components._tooltipIconLink("javascript:void(0)", "close", "bottom", "Cancel", 32)</span>
                    </button>
                </span>
            </td>
        </tr>
    }
    </tbody>
</table>

<script type="text/javascript">
    function updateCoachNotes(appointmentId, coachNotes){
        $.confirm({
            closeIcon: true,
            title: 'Session Notes',
            content: '' +
            '<form action="" class="coachNoteForm">' +
            '<div class="form-group">' +
            '<label>Enter notes about the appointment here. </label>' +
            '<textarea cols="50" rows="10" class="coachNotes form-control" required>' + coachNotes +'</textarea>' +
            '</div>' +
            '</form>',
            buttons: {
                updateNotes: {
                    text: 'Update Coach Notes',
                    btnClass: 'btn-primary',
                    action: function () {
                        coachNotes = this.$content.find('.coachNotes').val();
                        $.ajax({
                            url: '/updateCoachNotes',
                            type: 'POST',
                            data: JSON.stringify({appointmentId: appointmentId, coachNotes: coachNotes }),
                            contentType: 'application/json',
                            success: function () {
                                $('#notesFor-'+appointmentId).attr("onclick",'updateCoachNotes("'+appointmentId+'", "'+coachNotes +'")');
                                $().val(coachNotes);
                                let spanIcon = $('#notesFor-'+appointmentId+' span');
                                if(coachNotes === '' || coachNotes === null) {
                                    spanIcon.removeClass('action-secondary');
                                    spanIcon.addClass('action-black');
                                } else {
                                    spanIcon.removeClass('action-black');
                                    spanIcon.addClass('action-secondary');

                                }
                            },
                            error: function (err) {
                                createAlert("danger","There was an error updating coach notes");
                            }
                        });
                    }
                },
            },
        });
    }

    function cancelAppointment(appointmentId) {
        $.confirm({
            title: 'Cancel Appointment',
            content: 'Are you sure you want to cancel this appointment?',
            buttons: {
                cancel: {
                    text: "Nevermind",
                    btClass: "btn"
                },
                updateNotes: {
                    text: 'Cancel Appointment',
                    btnClass: 'btn-primary',
                    action: function () {
                        $.ajax({
                            url: '/cancelAppointment',
                            type: 'POST',
                            data: JSON.stringify({appointmentId: appointmentId}),
                            contentType: 'application/json',
                            success: function () {
                                $('.'+appointmentId).hide();
                                createAlert("success", "Appointment cancelled.");
                            },
                            error: function (err) {
                                console.log(err);
                            }
                        });
                    }
                },
            },
        });
    }

    $(document).ready(function () {
        /* Format dates for humans */
        $('.date').each(function () {
            $(this).text(moment($(this).text()).format('MMM DD YYYY, hh:mm A'));
        });

        $('.appointmentNotes').shorten({
            showChars: 150
        });
        $('#appointmentList').DataTable({
            dom: 'frtlip',
            responsive: true
        });
    });

</script>