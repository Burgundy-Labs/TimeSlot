<script type="text/javascript">

var selectedEvents = [];

/*
    Bug: FullCalendar won't load up a Calendar control if it's not on a displayed page.
         Since the calendar isn't loaded when the page loads, but after you click the tab for it, the calendar doesn't show up.
    Fixed: 10/26
    Solution: The best solution I could find that other people used was to make the calendar creation into a function, and keep trying to load the
              calendar. It will only load, however, when the calendar ID is visible on the page.
 */
$(document).ready(function () {
    createMakeAppointmentCalendar();
});

function createMakeAppointmentCalendar() {
    var visibleEvents = [];
    if ($('#calendar').is(':visible')) { //if the container is visible on the page
        $('#calendar').fullCalendar({
            height: 'auto',
            selectAllow: function(selectInfo) {
                window['moment-range'].extendMoment(moment);
                var okay = false;
                visibleEvents.forEach(function(item) {
                    console.log(item.start);
                    const range = moment.range(item.start, item.end);
                    var selectStart = moment(selectInfo.start);
                    var selectEnd = moment(selectInfo.end);
                    if((selectStart.within(range) && selectEnd.within(range))){
                        okay = true;

                    }
                });
                return okay;
            },
            allDaySlot: false,
            defaultView: 'agendaWeek',
            editable: false,
            weekends: false,
            selectable: true,
            /* TODO pull from open / close hours of operation in settings page */
            minTime: "10:00",
            maxTime: "21:00",
            events: function (start, end, timezone, callback) {
                var csrfToken = $('input[name="csrfToken"]').attr('value');
                $.ajaxSetup({
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Csrf-Token', csrfToken);
                    }
                });
                $.ajax({
                    url: '/availableSlots/' + '@UserController.getCurrentUser.getUid',
                    type: 'GET',
                    success: function (response) {
                        var events = [];
                        $(response).each(function () {
                            var event = {
                                id: $(this).attr('availabilityId'),
                                title: "One-Time",
                                start: $(this).attr('startDate'),
                                end: $(this).attr('endDate'),
                                dow: [],
                                rendering: 'background'
                            };
                            visibleEvents.push($.extend({}, event));
                            if ($(this).attr("weekly") === true) {
                                event.title = "Weekly";
                                event.dow = [moment($(this).attr('startDate')).isoWeekday()];
                                event.start = moment($(this).attr('startDate')).format("HH:mm");
                                event.end = moment($(this).attr('endDate')).format("HH:mm");
                            }
                            events.push(event);
                        });
                        callback(events);
                    }
                })
            },
            eventRender: function (event, eventElement) {
                eventElement.find("div.fc-content").prepend("<button onclick='removeAppointment(\"" + event + "\")' class='no-button eventDelete'><i class=\"material-icons md-18\">close</i></button>");
            },
            select: function (start, end, jsEvent, view) {
                if(($("#calendar").fullCalendar( 'clientEvents', [1])).length > 0) {
                    $.alert({
                        title: "Hold on there",
                        content: "You already have an appointment slot selected, cancel the current one to change your time.",
                        buttons: {
                            ok: {
                                text: "Okay"
                            }
                        }
                    })
                } else {
                var newAppointment = {
                    title : "Appointment",
                    id: 1,
                    userId: '@UserController.getCurrentUser.getUid',
                    start: moment(start).format(),
                    end: moment(end).format(),
                    weekly: false
                };
                $.confirm({
                    title: 'Confirm Appointment',
                    content: 'Do you want to create an appointment for this time?',
                    theme: 'modern',
                    buttons: {
                        yes: {
                            text: 'Yes, Create',
                            btnClass: 'btn-primary',
                            keys: ['enter', 'shift'],
                            action: function () {
                                $('#calendar').fullCalendar('renderEvent', newAppointment, true);
                            }
                        },
                        cancel: {
                            text: 'No, Cancel.'
                        }
                    }
                });
                }
            },
            selectOverlap: function(event) {
                return event.rendering === 'background';
            }
        });
    } else {
        setTimeout(createMakeAppointmentCalendar, 50); //wait 50 ms, then try again
    }
}

function removeAppointment() {
$('#calendar').fullCalendar( 'removeEvents', [1]);
}

</script>
<br/>
    <div class="row">
        <div class="col-md-12" id="calendarContainer">
            <div id='calendar'></div>
        </div>
    </div>

